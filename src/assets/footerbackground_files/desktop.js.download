(function () {

  // Dynamically add the stylesheet to the page
  var link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = "https://cdn.myscheme.in/myscheme-chat-sdk/desktop-bot.css"; // Make sure to provide the correct path to your CSS file
  document.head.appendChild(link);

  // Create the floating button
  var chatbotButton = document.createElement("div");
  chatbotButton.id = "chatbot-button";
  chatbotButton.innerHTML =
    '<img src="https://cdn.myscheme.in/images/chaticon/icon_white.svg" alt="Chat" style="width: 60px; height: 60px; border-radius: 50%;">';
  document.body.appendChild(chatbotButton);

  // Create the overlay for the blurred background
  var blurOverlay = document.createElement("div");
  blurOverlay.id = "blur-overlay";
  document.body.appendChild(blurOverlay);

  // Create the chat window (hidden by default)
  var chatbotWindow = document.createElement("div");
  chatbotWindow.id = "chatbot-window";
  chatbotWindow.style.position = "fixed";
  chatbotWindow.style.bottom = "0px";
  chatbotWindow.style.right = "0px";
  chatbotWindow.style.width = "100vw";
  chatbotWindow.style.height = "95vh";
  chatbotWindow.style.backgroundColor = "white";
  chatbotWindow.style.borderRadius = "40px 40px 0px 0px";
  chatbotWindow.style.overflow = "hidden";
  chatbotWindow.style.zIndex = "1000"; // Above the blur
  chatbotWindow.style.display = "none";
  chatbotWindow.innerHTML =
    '<iframe id="chatbot-iframe"  allow="clipboard-write" src="https://aistore.myscheme.in/6t4rIofAaIAEgu2P9lmtD?isEmbed=true" style="width: 100%; height: 100%; border: none;"></iframe>';
  document.body.appendChild(chatbotWindow);

  // Get the iframe element
  var chatbotIframe = document.getElementById("chatbot-iframe").contentWindow;

  // Create the close button
  var closeChatbotButton = document.createElement("div");
  closeChatbotButton.id = "close-chatbot-button";
  
  closeChatbotButton.innerHTML =
    '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>';
  document.body.appendChild(closeChatbotButton);

  // Toggle chat window and overlay visibility
  chatbotButton.addEventListener("click", function () {
    if (chatbotWindow.style.display === "none") {
      chatbotWindow.style.display = "block";
      closeChatbotButton.style.display = "flex";
      blurOverlay.style.display = "block"; // Show the blurred overlay
      chatbotButton.style.display = "none";
      chatbotIframe.postMessage({ action: "handelOpeningBot" }, "*");
    } else {
      // Send a message to the iframe when closed
      chatbotIframe.postMessage({ action: "handelCloseBotIcon" }, "*");
    }
  });

  // Close chat window and overlay when clicking the close button
  closeChatbotButton.addEventListener("click", function () {
    // Send a message to the iframe when closed
    chatbotIframe.postMessage({ action: "handelCloseBotIcon" }, "*");
  });

  // Close chat window and overlay when clicking outside the chat window (on the overlay)
  blurOverlay.addEventListener("click", function () {
    // Send a message to the iframe when closed
    chatbotIframe.postMessage({ action: "handelCloseBotIcon" }, "*");
  });

  // Listen for the postMessage to close the chatbot
  window.addEventListener("message", function (event) {
    if (event.data.action === "handelCloseBotModal") {
      chatbotWindow.style.display = "none"; // Close the chatbot window
      closeChatbotButton.style.display = "none";
      blurOverlay.style.display = "none"; // Hide the blurred overlay
      chatbotButton.style.display = "flex";
    }
  });
})();
